!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("Backbone"),require("Backgrid"),require("_"),require("jQuery")):"function"==typeof define&&define.amd?define(["Backbone","Backgrid","_","jQuery"],e):"object"==typeof exports?exports["Backgrid.Extension.ColumnManager"]=e(require("Backbone"),require("Backgrid"),require("_"),require("jQuery")):t["Backgrid.Extension.ColumnManager"]=e(t.Backbone,t.Backgrid,t._,t.jQuery)}(this,function(t,e,n,i){return function(t){function e(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return t[i].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";var i=n(3),o=n(4),s=n(1),r=n(2);r.Extension.ColumnManager=function(t,e,n){i.extend(this,s.Events);var o={initialColumnsVisible:null,trackSize:!0,trackOrder:!0,trackVisibility:!0,stateChecking:"strict",saveState:!1,saveStateKey:"",saveStateLocation:"localStorage",loadStateOnInit:!1};if(this.options=i.extend({},o,e),this.state=[],t instanceof r.Columns){this.columns=t,t.columnManager=this,this.addManagerToColumns();var a=this.options.loadStateOnInit?this.loadState():!1;if(n&&this.checkStateValidity(n)?this.setState(n,!0):a?this.setState(a,!0):(this.setInitialColumnVisibility(),this.setState(this.getStateFromColumns())),this.options.trackVisibility||this.options.trackSize||this.options.trackOrder){var l=""+(this.options.trackVisibility?"change:renderable ":"")+(this.options.trackSize?"resize ":"")+(this.options.trackOrder?"ordered":"");this.columns.on(l,i.bind(this.stateUpdateHandler,this))}}else console.error("Backgrid.ColumnManager: options.columns is not an instance of Backgrid.Columns")},r.Extension.ColumnManager.prototype.setInitialColumnVisibility=function(){var t=this,e=t.options.initialColumnsVisible;e&&t.columns.each(function(t,n){t.set("renderable",t.get("alwaysVisible")?!0:e>n)})},r.Extension.ColumnManager.prototype.addManagerToColumns=function(){var t=this;t.columns.each(function(e){e.get("headerCell")===r.Extension.ColumnManager.ColumnVisibilityHeaderCell&&e.set("headerCell",e.get("headerCell").extend({columnManager:t})),e.get("headerCell")instanceof r.Extension.ColumnManager.ColumnVisibilityHeaderCell&&(e.get("headerCell").columnManager=t)})},r.Extension.ColumnManager.prototype.getColumn=function(t){return(i.isNumber(t)||i.isString(t))&&(t=this.columns.get(t)),t instanceof r.Column?t:!1},r.Extension.ColumnManager.prototype.hideColumn=function(t){var e=this.getColumn(t);e&&e.set("renderable",!1)},r.Extension.ColumnManager.prototype.showColumn=function(t){var e=this.getColumn(t);e&&e.set("renderable",!0)},r.Extension.ColumnManager.prototype.toggleColumnVisibility=function(t){var e=this.getColumn(t);e&&(e.get("renderable")?this.hideColumn(e):this.showColumn(e))},r.Extension.ColumnManager.prototype.getColumnCollection=function(){return this.columns},r.Extension.ColumnManager.prototype.setState=function(t,e){var n=this;return i.filter(t,function(e){if(!i.has(e,"name"))return!1;var o=n.columns.findWhere({name:t.name});return"undefined"!=typeof o}),n.checkStateValidity(t)&&t!==n.state?(n.state=t,n.trigger("state-changed",t),e?n.applyStateToColumns():n.saveState()):!1},r.Extension.ColumnManager.prototype.getState=function(){return this.state},r.Extension.ColumnManager.prototype.checkStateValidity=function(t){function e(){return i.every(t,function(t){var e=!0;return i.has(t,"name")||(e=!1),i.has(t,"renderable")&&(i.isBoolean(t.renderable)||(e=!1)),i.has(t,"displayOrder")&&(i.isNumber(t.displayOrder)||(e=!1)),i.has(t,"width")&&(i.isNumber(t.width)||i.isString(t.width)||(e=!1)),e})}if(!i.isArray(t)&&i.isEmpty(t))return!1;if("loose"===this.options.stateChecking)return e();if(t.length!==this.columns.length&&!e())return!1;var n=this.columns.map(function(t){return t.get("name")}),o=i.map(t,function(t){return t.name});return n.sort().toString()===o.sort().toString()},r.Extension.ColumnManager.prototype.loadState=function(){var t=JSON.parse(this.getStorage().getItem(this.getStorageKey()));return this.checkStateValidity(t)?t:!1},r.Extension.ColumnManager.prototype.saveState=function(t){return this.options.saveState||t?(this.getStorage().setItem(this.getStorageKey(),JSON.stringify(this.state)),this.trigger("state-saved"),!0):!1},r.Extension.ColumnManager.prototype.getStorage=function(){return"undefined"!=typeof Storage?"sessionStorage"===this.options.saveStateLocation?sessionStorage:localStorage:(console.error("ColMrg: No storage support detected. State won't be saved."),!1)},r.Extension.ColumnManager.prototype.getStorageKey=function(){return this.options.saveStateKey?"backgrid-colmgr-"+this.options.saveStateKey:"backgrid-colmgr"},r.Extension.ColumnManager.prototype.stateUpdateHandler=function(){var t=this.getStateFromColumns();return this.setState(t)},r.Extension.ColumnManager.prototype.getStateFromColumns=function(){var t=this;return this.columns.map(function(e){var n={name:e.get("name")};return t.options.trackVisibility&&(n.renderable=e.get("renderable")),t.options.trackOrder&&(n.displayOrder=e.get("displayOrder")),t.options.trackSize&&(n.width=e.get("width")),n})},r.Extension.ColumnManager.prototype.applyStateToColumns=function(){var t=this,e=!1;i.each(this.state,function(n){var o=t.columns.findWhere({name:n.name});if(i.has(n,"renderable")&&o.set("renderable",n.renderable),i.has(n,"width")){var s=o.get("width");o.set("width",n.width,{silent:!0}),s!==n.width&&o.trigger("resize",o,n.width,s)}i.has(n,"displayOrder")&&(n.displayOrder!==o.get("displayOrder")&&(e=!0),o.set("displayOrder",n.displayOrder,{silent:!0}))}),e&&(t.columns.sort(),t.columns.trigger("ordered"))};var a=s.View.extend({className:"columnmanager-dropdown-item",tagName:"li",initialize:function(t){this.columnManager=t.columnManager,this.column=t.column,this.template=t.template,i.bindAll(this,"render","toggleVisibility"),this.column.on("change:renderable",this.render,this),this.el.addEventListener("click",this.toggleVisibility,!0)},render:function(){return this.$el.empty(),this.$el.append(this.template({label:this.column.get("label")})),this.column.get("renderable")?this.$el.addClass(this.column.get("renderable")?"visible":null):this.$el.removeClass("visible"),this},toggleVisibility:function(t){t&&this.stopPropagation(t),this.columnManager.toggleColumnVisibility(this.column)},stopPropagation:function(t){t.stopPropagation(),t.stopImmediatePropagation(),t.preventDefault()}}),l=s.View.extend({className:"columnmanager-dropdown-container",initialize:function(t){this.options=t,this.columnManager=t.columnManager,this.ItemView=t.DropdownItemView instanceof s.View?t.DropdownItemView:a,this.$dropdownButton=t.$dropdownButton,this.on("dropdown:opened",this.open,this),this.on("dropdown:closed",this.close,this),this.columnManager.columns.on("add remove",this.render,this)},render:function(){var t=this;return t.$el.empty(),this.columnManager.columns.each(function(e){e.get("alwaysVisible")||t.$el.append(new t.ItemView({column:e,columnManager:t.columnManager,template:t.options.dropdownItemTemplate}).render().el)}),this},open:function(){this.$el.addClass("open");var t,e=this.$dropdownButton;if("auto"===this.options.align){var n=document.body.clientWidth||document.body.clientWidth;t=e.offset().left+this.$el.outerWidth()>n?"left":"right"}else t="left"===this.options.align||"right"===this.options.align?"right"===this.options.align?"right":"left":"right";var i;"left"===t?(i=e.offset().left+e.outerWidth()-this.$el.outerWidth(),this.$el.css("left",i+"px")):(i=e.offset().left,this.$el.css("left",i+"px"));var o=e.offset().top+e.outerHeight();this.$el.css("top",o+"px")},close:function(){this.$el.removeClass("open")}});r.Extension.ColumnManagerVisibilityControl=s.View.extend({tagName:"div",className:"columnmanager-visibilitycontrol",defaultEvents:{click:"stopPropagation"},defaultOpts:{width:null,closeOnEsc:!0,closeOnClick:!0,openOnInit:!1,columnManager:null,buttonTemplate:i.template("<button class='dropdown-button'>...</button>"),DropdownView:l,dropdownAlign:"auto",DropdownItemView:a,dropdownItemTemplate:i.template("<span class='indicator'></span><span class='column-label'><%= label %></span>")},initialize:function(t){this.options=i.extend({},this.defaultOpts,t),this.events=i.extend({},this.defaultEvents,this.events||{}),this.columnManager=t.columnManager,!this.columnManager instanceof r.Extension.ColumnManager&&console.error("Backgrid.ColumnManager: options.columns is not an instance of Backgrid.Columns"),i.bindAll(this,"deferClose","stopDeferClose","closeOnEsc","toggle","render"),document.body.addEventListener("click",this.deferClose,!0),this.el.addEventListener("click",this.stopDeferClose,!0),this.options.closeOnEsc&&document.body.addEventListener("keyup",this.closeOnEsc,!1),this.el.addEventListener("click",this.toggle,!1),this.setup(),this.view.on("dropdown:close",this.close,this),this.view.on("dropdown:open",this.open,this)},delayStart:function(){clearTimeout(this.closeTimeout),this.delayTimeout=setTimeout(this.open.bind(this),this.options.delay)},delayEnd:function(){clearTimeout(this.delayTimeout),this.closeTimeout=setTimeout(this.close.bind(this),300)},setup:function(){this.options.width&&this.$el.width(this.options.width+"px"),this.$dropdownButton=o(this.options.buttonTemplate());var t={columnManager:this.columnManager,DropdownItemView:this.options.DropdownItemView,dropdownItemTemplate:this.options.dropdownItemTemplate,align:this.options.dropdownAlign,$dropdownButton:this.$dropdownButton};this.view=this.options.DropdownView instanceof s.View?new this.options.DropdownView(t):new l(t)},render:function(){return this.$el.empty(),this.$el.append(this.$dropdownButton),this.view.render(),o(document.body).append(this.view.el),this},stopPropagation:function(t){t.stopPropagation(),t.stopImmediatePropagation(),t.preventDefault()},toggle:function(t){this.isOpen!==!0?this.open(t):this.close(t)},open:function(t){clearTimeout(this.closeTimeout),clearTimeout(this.deferCloseTimeout),t&&(t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),t.cancelBubble=!0),this.isOpen||(this.isOpen=!0,this.$el.addClass("open"),this.trigger("dropdown:opened"),this.view.trigger("dropdown:opened"))},close:function(){this.isOpen&&(this.isOpen=!1,this.$el.removeClass("open"),this.trigger("dropdown:closed"),this.view.trigger("dropdown:closed"))},closeOnEsc:function(t){27===t.which&&this.deferClose()},deferClose:function(){this.deferCloseTimeout=setTimeout(this.close.bind(this),0)},stopDeferClose:function(){clearTimeout(this.deferCloseTimeout)}}),r.Extension.ColumnManager.ColumnVisibilityHeaderCell=r.HeaderCell.extend({initialize:function(){r.HeaderCell.prototype.initialize.apply(this,arguments),this.$el.addClass(this.column.get("name"))},render:function(){this.$el.empty();var t=new r.Extension.ColumnManagerVisibilityControl({columnManager:this.columnManager});return this.$el.html(t.render().el),this.delegateEvents(),this}})},function(e){e.exports=t},function(t){t.exports=e},function(t){t.exports=n},function(t){t.exports=i}])});