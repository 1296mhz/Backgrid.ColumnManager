!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("Backbone"),require("Backgrid"),require("_")):"function"==typeof define&&define.amd?define(["Backbone","Backgrid","_"],n):"object"==typeof exports?exports["Backgrid.Extension.ColumnManager"]=n(require("Backbone"),require("Backgrid"),require("_")):e["Backgrid.Extension.ColumnManager"]=n(e.Backbone,e.Backgrid,e._)}(this,function(e,n,t){return function(e){function n(i){if(t[i])return t[i].exports;var o=t[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){"use strict";var i=t(3),o=t(1),s=t(2);s.Extension.ColumnManager=function(e,n){var t={initialColumnsVisible:null};this.options=i.extend({},t,n),e instanceof s.Columns?(this.columns=e,this.setInitialColumnVisibility()):console.error("Backgrid.ColumnManager: options.columns is not an instance of Backgrid.Columns")},s.Extension.ColumnManager.prototype.setInitialColumnVisibility=function(){var e=this.options.initialColumnsVisible;this.columns instanceof s.Columns&&e&&this.columns.each(function(n,t){n.set("renderable",e>t)})},s.Extension.ColumnManager.prototype.getColumn=function(e){return(i.isNumber(e)||i.isString(e))&&(e=this.columns.get(e)),e instanceof s.Column?e:!1},s.Extension.ColumnManager.prototype.hideColumn=function(e){var n=this.getColumn(e);n&&n.set("renderable",!1)},s.Extension.ColumnManager.prototype.showColumn=function(e){var n=this.getColumn(e);n&&n.set("renderable",!0)},s.Extension.ColumnManager.prototype.toggleColumnVisibility=function(e){var n=this.getColumn(e);n&&(n.get("renderable")?this.hideColumn(n):this.showColumn(n))},s.Extension.ColumnManager.prototype.getColumnCollection=function(){return this.columns};var l=o.View.extend({className:"columnmanager-dropdown-item",initialize:function(e){this.columnManager=e.columnManager,this.column=e.column,i.bindAll(this,"render","toggleVisibility"),this.column.on("change:renderable",this.render,this),this.el.addEventListener("click",this.toggleVisibility,!0)},render:function(){this.$el.empty();var e=this.column;return this.$el.append("<div><span>"+e.get("name")+"</span><span>"+(e.get("renderable")?" Y":" N")+"</span></div>"),this},toggleVisibility:function(e){e&&this.stopPropagation(e),this.columnManager.toggleColumnVisibility(this.column)},stopPropagation:function(e){e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault()}}),r=o.View.extend({className:"columnmanager-dropdown-container",initialize:function(e){this.columnManager=e.columnManager,this.on("dropdown:opened",this.open,this),this.on("dropdown:closed",this.close,this),this.columnManager.columns.on("add remove",this.render,this)},render:function(){var e=this;e.$el.empty(),this.columnManager.columns.each(function(n){e.$el.append(new l({column:n,columnManager:e.columnManager}).render().el)})},open:function(){this.$el.addClass("open")},close:function(){this.$el.removeClass("open")}});s.Extension.ColumnManagerVisibilityControl=o.View.extend({tagName:"div",className:"columnmanager-visibilitycontrol",defaultEvents:{click:"stopPropagation"},defaultOpts:{width:200,closeOnEsc:!0,openOnInit:!1,columnManager:null,view:null},initialize:function(e){this.options=i.extend({},this.defaultOpts,e),this.events=i.extend({},this.defaultEvents,this.events||{}),this.columnManager=e.columnManager,!this.columnManager instanceof s.Extension.ColumnManager&&console.error("Backgrid.ColumnManager: options.columns is not an instance of Backgrid.Columns"),i.bindAll(this,"deferClose","stopDeferClose","closeOnEsc","toggle","render"),document.body.addEventListener("click",this.deferClose,!0),this.el.addEventListener("click",this.stopDeferClose,!0),this.options.closeOnEsc&&document.body.addEventListener("keyup",this.closeOnEsc,!1),this.el.addEventListener("click",this.toggle,!1),this.setup(),this.view.on("dropdown:close",this.close,this),this.view.on("dropdown:open",this.open,this)},delayStart:function(){clearTimeout(this.closeTimeout),this.delayTimeout=setTimeout(this.open.bind(this),this.options.delay)},delayEnd:function(){clearTimeout(this.delayTimeout),this.closeTimeout=setTimeout(this.close.bind(this),300)},setup:function(){this.$el.width(this.options.width+"px"),this.view=this.options.view instanceof o.View?this.options.view:new r({columnManager:this.columnManager})},render:function(){return this.$el.empty(),this.$el.append("<button>DD</button>"),this.view.render(),this.$el.append(this.view.el),this},stopPropagation:function(e){e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault()},toggle:function(e){this.isOpen!==!0?this.open(e):this.close(e)},open:function(e){clearTimeout(this.closeTimeout),clearTimeout(this.deferCloseTimeout),e&&e.stopPropagation(),this.isOpen||(this.isOpen=!0,this.$el.addClass("open"),this.trigger("dropdown:opened"),this.view.trigger("dropdown:opened"),this.setDropdownPosition())},setDropdownPosition:function(){this.view.$el.css("top",this.$el.height())},close:function(){this.isOpen&&(this.isOpen=!1,this.$el.removeClass("open"),this.trigger("dropdown:closed"),this.view.trigger("dropdown:closed"))},closeOnEsc:function(e){27===e.which&&this.deferClose()},deferClose:function(){this.deferCloseTimeout=setTimeout(this.close.bind(this),0)},stopDeferClose:function(){clearTimeout(this.deferCloseTimeout)}})},function(n){n.exports=e},function(e){e.exports=n},function(e){e.exports=t}])});